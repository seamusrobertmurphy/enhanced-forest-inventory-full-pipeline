---
title: "Production Code: 'CHM-based Pipeline'"
author: "Cabin-GIS"
date: "21/05/2022"
output: 
  pdf_document:
    toc: TRUE
    toc_depth: 5
    number_sections: FALSE
    df_print: tibble
    latex_engine: xelatex
  zotero: TRUE
---

```{r setup, echo=FALSE, message=FALSE,warning=FALSE, error=FALSE}
library(sf)
library(sp)
library(terra)
library(raster)
library(dplyr)
library(caret)
library(caretEnsemble)
library(ForestTools)
library(lidR)
library(randomForest)
library(e1071)
library(rgdal)
library(rgeos)
library(Rcpp)
library(rmarkdown)
library(knitr)
library(MASS)
library(car)
#devtools::install_github(("gearslaboratory/gdalUtils"))
library(gdalUtils)
#library(gdalUtilities)
#webshot::install_phantomjs(force = TRUE)
#knit_hooks$set(webgl = hook_webgl)
#knit_hooks$set(rgl.static = hook_rgl)
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, error=FALSE, message = FALSE)
set.seed(123)
```

## Action

The following markdown report provides a complete run-through and guide of a raster-to-raster workflow to generating Whole Stem Volume (m\^3/ha: WSVHA) raster estimates from initial phases of importing liDAR tiles, to deriving stem-detection map and a 95% canopy height model, to generating and masking DEM-based and species covariates, to fitting and training models with faib.csv data, to finally making spatial predictions using raster stack of covariates. The graphical abstract below is offered as reference guide.

![](images/Graphical_Abstract.png)

## Import LiDAR: DEM mosaics

```{r, eval=FALSE}
filez_be_gaspard = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/gaspard/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_gaspard <- lapply(filez_be_gaspard, raster)
elev_raster_gaspard = do.call(merge, c(elev_raster_list_gaspard, tolerance = 1))
elev_rast_gaspard = terra::rast(elev_raster_gaspard)
terra::crs(elev_rast_gaspard) = "epsg:3005"
elev_rast_gaspard = terra::aggregate(elev_rast_gaspard, fact = 100, fun = mean)
writeRaster(elev_rast_gaspard, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/gaspard/elev_raster_100m_gaspard.tif", overwrite=TRUE)

filez_be_quesnel = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/quesnel/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_quesnel <- lapply(filez_be_quesnel, raster)
elev_raster_quesnel = do.call(merge, c(elev_raster_list_quesnel, tolerance = 1))
elev_rast_quesnel = terra::rast(elev_raster_quesnel)
terra::crs(elev_rast_quesnel) = "epsg:3005"
elev_rast_quesnel = terra::aggregate(elev_rast_quesnel, fact = 100, fun = mean)
writeRaster(elev_rast_quesnel, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/quesnel/elev_raster_100m_quesnel.tif", overwrite=TRUE)

filez_be_ahbau = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/ahbau/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_ahbau <- lapply(filez_be_ahbau, raster)
elev_raster_ahbau = do.call(merge, c(elev_raster_list_ahbau, tolerance = 1))
elev_rast_ahbau = terra::rast(elev_raster_ahbau)
terra::crs(elev_rast_ahbau) = "epsg:3005"
elev_rast_ahbau = terra::aggregate(elev_rast_ahbau, fact = 100, fun = mean)
writeRaster(elev_rast_ahbau, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/ahbau/elev_raster_100m_ahbau.tif", overwrite=TRUE)

filez_be_bells = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/bells/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_bells <- lapply(filez_be_bells, raster)
elev_raster_bells = do.call(merge, c(elev_raster_list_bells, tolerance = 1))
elev_rast_bells = terra::rast(elev_raster_bells)
terra::crs(elev_rast_bells) = "epsg:3005"
elev_rast_bells = terra::aggregate(elev_rast_bells, fact = 100, fun = mean)
writeRaster(elev_rast_bells, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/bells/elev_raster_100m_bells.tif", overwrite=TRUE)

filez_be_big_valley = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/big_valley/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_big_valley <- lapply(filez_be_big_valley, raster)
elev_raster_big_valley = do.call(merge, c(elev_raster_list_big_valley, tolerance = 1))
elev_rast_big_valley = terra::rast(elev_raster_big_valley) 
terra::crs(elev_rast_big_valley) = "epsg:3005"
elev_rast_big_valley = terra::aggregate(elev_rast_big_valley, fact = 100, fun = mean)
writeRaster(elev_rast_big_valley, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/big_valley/elev_raster_100m_big_valley.tif", overwrite=TRUE)

filez_be_cariboo_lake = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/cariboo_lake/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_cariboo_lake <- lapply(filez_be_cariboo_lake, raster)
elev_raster_cariboo_lake = do.call(merge, c(elev_raster_list_cariboo_lake, tolerance = 1))
elev_rast_cariboo_lake = terra::rast(elev_raster_cariboo_lake)
terra::crs(elev_rast_cariboo_lake) = "epsg:3005"
elev_rast_cariboo_lake = terra::aggregate(elev_rast_cariboo_lake, fact = 100, fun = mean)
writeRaster(elev_rast_cariboo_lake, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/cariboo_lake/elev_raster_100m_cariboo_lake.tif", overwrite=TRUE)

filez_be_charleson_marvincreek = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/charleson_marvincreek/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$')
elev_raster_list_charleson_marvincreek <- lapply(filez_be_charleson_marvincreek, raster)
elev_raster_charleson_marvincreek = do.call(merge, c(elev_raster_list_charleson_marvincreek, tolerance = 1))
elev_rast_charleson_marvincreek = terra::rast(elev_raster_charleson_marvincreek)
terra::crs(elev_rast_charleson_marvincreek) = "epsg:3005"
elev_rast_charleson_marvincreek = terra::aggregate(elev_rast_charleson_marvincreek, fact = 100, fun = mean)
writeRaster(elev_raster_charleson_marvincreek, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/charleson_marvincreek/elev_raster_100m_charleson_marvincreek.tif", overwrite=TRUE)

filez_be_dash = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/dash/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_dash <- lapply(filez_be_dash, raster)
elev_raster_dash = do.call(merge, c(elev_raster_list_dash, tolerance = 1))
elev_rast_dash = terra::rast(elev_raster_dash)
terra::crs(elev_rast_dash) = "epsg:3005"
elev_rast_dash = terra::aggregate(elev_rast_dash, fact = 100, fun = mean)
writeRaster(elev_raster_dash, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/dash/elev_raster_100m_dash.tif", overwrite=TRUE)

filez_be_hawks_creek = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/hawks_creek/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_hawks_creek <- lapply(filez_be_hawks_creek, raster)
elev_raster_hawks_creek = do.call(merge, c(elev_raster_list_hawks_creek, tolerance = 1))
elev_rast_hawks_creek = terra::rast(elev_raster_hawks_creek)
terra::crs(elev_rast_hawks_creek) = "epsg:3005"
elev_rast_hawks_creek = terra::aggregate(elev_rast_hawks_creek, fact = 100, fun = mean)
writeRaster(elev_raster_hawks_creek, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/hawks_creek/elev_raster_100m_hawks_creek.tif", overwrite=TRUE)

filez_be_little_river = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/little_river/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_little_river <- lapply(filez_be_little_river, raster)
elev_raster_little_river = do.call(merge, c(elev_raster_list_little_river, tolerance = 1))
elev_rast_little_river = terra::rast(elev_raster_little_river)
terra::crs(elev_rast_little_river) = "epsg:3005"
elev_rast_little_river = terra::aggregate(elev_rast_little_river, fact = 100, fun = mean)
writeRaster(elev_raster_little_river, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/little_river/elev_raster_100m_little_river.tif", overwrite=TRUE)

filez_be_little_swift = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/little_swift/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_little_swift <- lapply(filez_be_little_swift, raster)
elev_raster_little_swift = do.call(merge, c(elev_raster_list_little_swift, tolerance = 1))
elev_rast_little_swift = terra::rast(elev_raster_little_swift)
terra::crs(elev_rast_little_swift) = "epsg:3005"
elev_rast_little_swift = terra::aggregate(elev_rast_little_swift, fact = 100, fun = mean)
writeRaster(elev_raster_little_swift, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/little_swift/elev_raster_100m_little_swift.tif", overwrite=TRUE)

filez_be_mcintosh = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/mcintosh/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_mcintosh <- lapply(filez_be_mcintosh, raster)
elev_raster_mcintosh = do.call(merge, c(elev_raster_list_mcintosh, tolerance = 1))
elev_rast_mcintosh = terra::rast(elev_raster_mcintosh) 
terra::crs(elev_rast_mcintosh) = "epsg:3005"
elev_rast_mcintosh = terra::aggregate(elev_rast_mcintosh, fact = 100, fun = mean)
writeRaster(elev_raster_mcintosh, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/mcintosh/elev_raster_100m_mcintosh.tif", overwrite=TRUE)

filez_be_meldrum = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/meldrum/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_meldrum = lapply(filez_be_meldrum, raster)
elev_raster_meldrum = do.call(merge, c(elev_raster_list_meldrum, tolerance = 1))
elev_rast_meldrum = terra::rast(elev_raster_meldrum) 
terra::crs(elev_rast_meldrum) = "epsg:3005"
elev_rast_meldrum = terra::aggregate(elev_rast_meldrum, fact = 100, fun = mean)
writeRaster(elev_raster_meldrum, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/meldrum/elev_raster_100m_meldrum.tif", overwrite=TRUE)

filez_be_phillips_anahim_lake = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/phillips_anahim_lake/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_phillips_anahim_lake <- lapply(filez_be_phillips_anahim_lake, raster)
elev_raster_phillips_anahim_lake = do.call(merge, c(elev_raster_list_phillips_anahim_lake, tolerance = 1))
elev_rast_phillips_anahim_lake = terra::rast(elev_raster_phillips_anahim_lake)
terra::crs(elev_rast_phillips_anahim_lake) = "epsg:3005"
elev_rast_phillips_anahim_lake = terra::aggregate(elev_rast_phillips_anahim_lake, fact = 100, fun = mean)
writeRaster(elev_rast_phillips_anahim_lake, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/phillips_anahim_lake/elev_raster_100m_phillips_anahim_lake.tif", overwrite=TRUE)

filez_be_piltz = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/piltz/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_piltz = lapply(filez_be_piltz, raster)
elev_raster_piltz = do.call(merge, c(elev_raster_list_piltz, tolerance = 1))
elev_rast_piltz = terra::rast(elev_raster_piltz)
terra::crs(elev_rast_piltz) = "epsg:3005"
elev_rast_piltz = terra::aggregate(elev_rast_piltz, fact = 100, fun = mean)
writeRaster(elev_rast_piltz, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/piltz/elev_raster_100m_piltz.tif", overwrite=TRUE)

filez_be_punky_clisbako = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/punky_clisbako/BareEarth", full.names = T, all.files = FALSE, pattern = '.tif$') 
elev_raster_list_punky_clisbako = lapply(filez_be_punky_clisbako, raster)
elev_raster_punky_clisbako = do.call(merge, c(elev_raster_list_punky_clisbako, tolerance = 1))
elev_rast_punky_clisbako = terra::rast(elev_raster_punky_clisbako) 
terra::crs(elev_rast_punky_clisbako) = "epsg:3005"
elev_rast_punky_clisbako = terra::aggregate(elev_rast_punky_clisbako, fact = 100, fun = mean)
writeRaster(elev_rast_punky_clisbako, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/punky_clisbako/elev_raster_100m_punky_clisbako.tif", overwrite=TRUE)

elev_raster_list = list(
  elev_raster_quesnel, elev_raster_gaspard, 
  elev_raster_ahbau, elev_raster_bells, 
  elev_raster_big_valley, elev_raster_cariboo_lake, 
  elev_raster_charleson_marvincreek, elev_raster_dash,
  elev_raster_hawks_creek, elev_raster_little_river,
  elev_raster_little_swift, elev_raster_mcintosh,
  elev_raster_meldrum, elev_raster_phillips_anahim_lake,
  elev_raster_piltz, elev_raster_punky_clisbako)
elev_raster_all = do.call(merge, c(elev_raster_list, tolerance = 1))
elev_rast_all = terra::rast(elev_raster_all)
writeRaster(elev_raster_all, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/elev_raster_100m_allAreas.tif", overwrite=TRUE)
```

```{r, fig.show='hold', out.width="25%", echo=FALSE}
elev_raster_gaspard = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/gaspard/elev_raster_100m_gaspard.tif")
elev_raster_quesnel = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/quesnel/elev_raster_100m_quesnel.tif")
elev_raster_ahbau = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/ahbau/elev_raster_100m_ahbau.tif")
elev_raster_bells = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/bells/elev_raster_100m_bells.tif")
elev_raster_big_valley = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/big_valley/elev_raster_100m_big_valley.tif")
elev_raster_cariboo_lake = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/cariboo_lake/elev_raster_100m_cariboo_lake.tif")
elev_raster_charleson_marvincreek = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/charleson_marvincreek/elev_raster_100m_charleson_marvincreek.tif")
elev_raster_dash = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/dash/elev_raster_100m_dash.tif")
elev_raster_hawks_creek = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/hawks_creek/elev_raster_100m_hawks_creek.tif")
elev_raster_little_river = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/little_river/elev_raster_100m_little_river.tif")
elev_raster_little_swift = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/little_swift/elev_raster_100m_little_swift.tif")
elev_raster_mcintosh = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/mcintosh/elev_raster_100m_mcintosh.tif")
elev_raster_meldrum = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/meldrum/elev_raster_100m_meldrum.tif")
elev_raster_phillips_anahim_lake = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/phillips_anahim_lake/elev_raster_100m_phillips_anahim_lake.tif")
elev_raster_piltz = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/piltz/elev_raster_100m_piltz.tif")
elev_raster_punky_clisbako = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/punky_clisbako/elev_raster_100m_punky_clisbako.tif")

elev_rast_gaspard = terra::rast(elev_raster_gaspard)
elev_rast_quesnel = terra::rast(elev_raster_quesnel)
elev_rast_ahbau = terra::rast(elev_raster_ahbau)
elev_rast_bells = terra::rast(elev_raster_bells)
elev_rast_big_valley = terra::rast(elev_raster_big_valley) 
elev_rast_cariboo_lake = terra::rast(elev_raster_cariboo_lake)
elev_rast_charleson_marvincreek = terra::rast(elev_raster_charleson_marvincreek)
elev_rast_dash = terra::rast(elev_raster_dash)
elev_rast_hawks_creek = terra::rast(elev_raster_hawks_creek)
elev_rast_little_river = terra::rast(elev_raster_little_river)
elev_rast_little_swift = terra::rast(elev_raster_little_swift)
elev_rast_mcintosh = terra::rast(elev_raster_mcintosh) 
elev_rast_meldrum = terra::rast(elev_raster_meldrum) 
elev_rast_phillips_anahim_lake = terra::rast(elev_raster_phillips_anahim_lake)
elev_rast_piltz = terra::rast(elev_raster_piltz)
elev_rast_punky_clisbako = terra::rast(elev_raster_punky_clisbako) 

terra::plot(elev_rast_gaspard, main = 'Gaspard DEM (1m res)')
terra::plot(elev_rast_quesnel, main = 'Quesnel DEM (1m res)')
terra::plot(elev_rast_ahbau, main = 'Ahbau DEM (1m res)')
terra::plot(elev_rast_bells, main = 'Bells DEM (1m res)')
terra::plot(elev_rast_big_valley, main = 'Big Valley DEM (1m res)')
terra::plot(elev_rast_cariboo_lake, main = 'Cariboo Lake DEM (1m res)')
terra::plot(elev_rast_charleson_marvincreek, main = 'Charleson Marvin Creek DEM (1m res)')
terra::plot(elev_rast_dash, main = 'Dash DEM (1m res)')
terra::plot(elev_rast_hawks_creek, main = 'Hawks Creek DEM (1m res)')
terra::plot(elev_rast_little_river, main = 'Little River DEM (1m res)')
terra::plot(elev_rast_little_swift, main = 'Little Swift DEM (1m res)')
terra::plot(elev_rast_mcintosh, main = 'McIntosh DEM (1m res)')
terra::plot(elev_rast_meldrum, main = 'Meldrum DEM (1m res)')
terra::plot(elev_rast_phillips_anahim_lake, main = 'Phillips Anahim Lake DEM (1m res)')
terra::plot(elev_rast_piltz, main = 'Piltz DEM (1m res)')
terra::plot(elev_rast_punky_clisbako, main = 'Punky Clisbako DEM (1m res)')
```

## Import LiDAR: CHM mosaics

```{r, eval=FALSE}
filez_vh_gaspard = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/gaspard/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_gaspard <- lapply(filez_vh_gaspard, raster)
lead_htop_raster_gaspard = do.call(merge, c(lead_htop_raster_list_gaspard, tolerance = 1))
lead_htop_rast_gaspard = terra::rast(lead_htop_raster_gaspard)
terra::crs(lead_htop_rast_gaspard) = "epsg:3005"
lead_htop_rast_gaspard = terra::aggregate(lead_htop_rast_gaspard, fact = 100, fun = mean)
writeRaster(lead_htop_raster_gaspard, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/gaspard/lead_htop_raster_100m_gaspard.tif", overwrite=TRUE)

filez_vh_quesnel = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/quesnel/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_quesnel <- lapply(filez_vh_quesnel, raster)
lead_htop_raster_quesnel = do.call(merge, c(lead_htop_raster_list_quesnel, tolerance = 1))
lead_htop_rast_quesnel = terra::rast(lead_htop_raster_quesnel)
terra::crs(lead_htop_rast_quesnel) = "epsg:3005"
lead_htop_rast_quesnel = terra::aggregate(lead_htop_rast_quesnel, fact = 100, fun = mean)
writeRaster(lead_htop_raster_quesnel, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/quesnel/lead_htop_raster_100m_quesnel.tif", overwrite=TRUE)

filez_vh_ahbau = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/ahbau/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_ahbau <- lapply(filez_vh_ahbau, raster)
lead_htop_raster_ahbau = do.call(merge, c(lead_htop_raster_list_ahbau, tolerance = 1))
lead_htop_rast_ahbau = terra::rast(lead_htop_raster_ahbau)
terra::crs(lead_htop_rast_ahbau) = "epsg:3005"
lead_htop_rast_ahbau = terra::aggregate(lead_htop_rast_ahbau, fact = 100, fun = mean)
writeRaster(lead_htop_raster_ahbau, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/ahbau/lead_htop_raster_100m_ahbau.tif", overwrite=TRUE)

filez_vh_bells = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/bells/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_bells <- lapply(filez_vh_bells, raster)
lead_htop_raster_bells = do.call(merge, c(lead_htop_raster_list_bells, tolerance = 1))
lead_htop_rast_bells = terra::rast(lead_htop_raster_bells)
terra::crs(lead_htop_rast_bells) = "epsg:3005"
lead_htop_rast_bells = terra::aggregate(lead_htop_rast_bells, fact = 100, fun = mean)
writeRaster(lead_htop_raster_bells, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/bells/lead_htop_raster_100m_bells.tif", overwrite=TRUE)

filez_vh_big_valley = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/big_valley/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_big_valley <- lapply(filez_vh_big_valley, raster)
lead_htop_raster_big_valley = do.call(merge, c(lead_htop_raster_list_big_valley, tolerance = 1))
lead_htop_rast_big_valley = terra::rast(lead_htop_raster_big_valley)
terra::crs(lead_htop_rast_big_valley) = "epsg:3005"
lead_htop_rast_big_valley = terra::aggregate(lead_htop_rast_big_valley, fact = 100, fun = mean)
writeRaster(lead_htop_raster_big_valley, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/big_valley/lead_htop_raster_100m_big_valley.tif", overwrite=TRUE)

filez_vh_cariboo_lake = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/cariboo_lake/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_cariboo_lake <- lapply(filez_vh_cariboo_lake, raster)
lead_htop_raster_cariboo_lake = do.call(merge, c(lead_htop_raster_list_cariboo_lake, tolerance = 1))
lead_htop_rast_cariboo_lake = terra::rast(lead_htop_raster_cariboo_lake)
terra::crs(lead_htop_rast_cariboo_lake) = "epsg:3005"
lead_htop_rast_cariboo_lake = terra::aggregate(lead_htop_rast_cariboo_lake, fact = 100, fun = mean)
writeRaster(lead_htop_raster_cariboo_lake, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/cariboo_lake/lead_htop_raster_100m_cariboo_lake.tif", overwrite=TRUE)

filez_vh_charleson_marvincreek = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/charleson_marvincreek/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_charleson_marvincreek <- lapply(filez_vh_charleson_marvincreek, raster)
lead_htop_raster_charleson_marvincreek = do.call(merge, c(lead_htop_raster_list_charleson_marvincreek, tolerance = 1))
lead_htop_rast_charleson_marvincreek = terra::rast(lead_htop_raster_charleson_marvincreek)
terra::crs(lead_htop_rast_charleson_marvincreek) = "epsg:3005"
lead_htop_rast_charleson_marvincreek = terra::aggregate(lead_htop_rast_charleson_marvincreek, fact = 100, fun = mean)
writeRaster(lead_htop_raster_charleson_marvincreek, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/chaleson_marvincreek/lead_htop_raster_100m_charleson_marvincreek.tif", overwrite=TRUE)

filez_vh_dash = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/dash/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_dash <- lapply(filez_vh_dash, raster)
lead_htop_raster_dash = do.call(merge, c(lead_htop_raster_list_dash, tolerance = 1))
lead_htop_rast_dash = terra::rast(lead_htop_raster_dash)
terra::crs(lead_htop_rast_dash) = "epsg:3005"
lead_htop_rast_dash = terra::aggregate(lead_htop_rast_dash, fact = 100, fun = mean)
writeRaster(lead_htop_raster_dash, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/hawks_creek/lead_htop_raster_100m_dash.tif", overwrite=TRUE)

filez_vh_hawks_creek = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/hawks_creek/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_hawks_creek <- lapply(filez_vh_hawks_creek, raster)
lead_htop_raster_hawks_creek = do.call(merge, c(lead_htop_raster_list_hawks_creek, tolerance = 1))
lead_htop_rast_hawks_creek = terra::rast(lead_htop_raster_hawks_creek)
terra::crs(lead_htop_rast_hawks_creek) = "epsg:3005"
lead_htop_rast_hawks_creek = terra::aggregate(lead_htop_rast_hawks_creek, fact = 100, fun = mean)
writeRaster(lead_htop_raster_hawks_creek, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/hawks_creek/lead_htop_raster_100m_hawks_creek.tif", overwrite=TRUE)

filez_vh_little_river = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/little_river/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_little_river <- lapply(filez_vh_little_river, raster)
lead_htop_raster_little_river = do.call(merge, c(lead_htop_raster_list_little_river, tolerance = 1))
lead_htop_rast_little_river = terra::rast(lead_htop_raster_little_river)
terra::crs(lead_htop_rast_little_river) = "epsg:3005"
lead_htop_rast_little_river = terra::aggregate(lead_htop_rast_little_river, fact = 100, fun = mean)
writeRaster(lead_htop_raster_little_river, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/little_river/lead_htop_raster_100m_little_river.tif", overwrite=TRUE)

filez_vh_little_swift = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/little_swift/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_little_swift <- lapply(filez_vh_little_swift, raster)
lead_htop_raster_little_swift = do.call(merge, c(lead_htop_raster_list_little_swift, tolerance = 1))
lead_htop_rast_little_swift = terra::rast(lead_htop_raster_little_swift)
terra::crs(lead_htop_rast_little_swift) = "epsg:3005"
lead_htop_rast_little_swift = terra::aggregate(lead_htop_rast_little_swift, fact = 100, fun = mean)
writeRaster(lead_htop_raster_little_swift, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/little_swift/lead_htop_raster_100m_little_swift.tif", overwrite=TRUE)

filez_vh_mcintosh = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/mcintosh/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_mcintosh <- lapply(filez_vh_mcintosh, raster)
lead_htop_raster_mcintosh = do.call(merge, c(lead_htop_raster_list_mcintosh, tolerance = 1))
lead_htop_rast_mcintosh = terra::rast(lead_htop_raster_mcintosh)
terra::crs(lead_htop_rast_mcintosh) = "epsg:3005"
lead_htop_rast_mcintosh = terra::aggregate(lead_htop_rast_mcintosh, fact = 100, fun = mean)
writeRaster(lead_htop_raster_mcintosh, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/mcintosh/lead_htop_raster_100m_mcintosh.tif", overwrite=TRUE)

filez_vh_meldrum = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/meldrum/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_meldrum = list(filez_vh_meldrum, raster)
lead_htop_raster_meldrum = do.call(merge, c(lead_htop_raster_list_meldrum, tolerance = 1))
lead_htop_rast_meldrum = terra::rast(lead_htop_raster_meldrum)
terra::crs(lead_htop_rast_meldrum) = "epsg:3005"
lead_htop_rast_meldrum = terra::aggregate(lead_htop_rast_meldrum, fact = 100, fun = mean)
writeRaster(lead_htop_raster_meldrum, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/meldrum/lead_htop_raster_100m_meldrum.tif", overwrite=TRUE)

filez_vh_phillips_anahim_lake = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/phillips_anahim_lake/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_phillips_anahim_lake <- lapply(filez_vh_phillips_anahim_lake, raster)
lead_htop_raster_phillips_anahim_lake = do.call(merge, c(lead_htop_raster_list_phillips_anahim_lake, tolerance = 1))
lead_htop_rast_phillips_anahim_lake = terra::rast(lead_htop_raster_phillips_anahim_lake)
terra::crs(lead_htop_rast_phillips_anahim_lake) = "epsg:3005"
lead_htop_rast_phillips_anahim_lake = terra::aggregate(lead_htop_rast_phillips_anahim_lake, fact = 100, fun = mean)
writeRaster(lead_htop_raster_phillips_anahim_lake, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/phillips_anahim_lake/lead_htop_raster_100m_phillips_anahim_lake.tif", overwrite=TRUE)

filez_vh_piltz = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/piltz/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_piltz <- lapply(filez_vh_piltz, raster)
lead_htop_raster_piltz = do.call(merge, c(lead_htop_raster_list_piltz, tolerance = 1))
lead_htop_rast_piltz = terra::rast(lead_htop_raster_piltz)
terra::crs(lead_htop_rast_piltz) = "epsg:3005"
lead_htop_rast_piltz = terra::aggregate(lead_htop_rast_piltz, fact = 100, fun = mean)
writeRaster(lead_htop_raster_piltz, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/piltz/lead_htop_raster_100m_piltz.tif", overwrite=TRUE)

filez_vh_punky_clisbako = list.files("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/punky_clisbako/VegHt", full.names = T, all.files = FALSE, pattern = '.tif$') 
lead_htop_raster_list_punky_clisbako <- lapply(filez_vh_punky_clisbako, raster)
lead_htop_raster_punky_clisbako = do.call(merge, c(lead_htop_raster_list_punky_clisbako, tolerance = 1))
lead_htop_rast_punky_clisbako = terra::rast(lead_htop_raster_punky_clisbako)
terra::crs(lead_htop_rast_punky_clisbako) = "epsg:3005"
lead_htop_rast_punky_clisbako = terra::aggregate(lead_htop_rast_punky_clisbako, fact = 100, fun = mean)
writeRaster(lead_htop_raster_punky_clisbako, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/punky_clisbako/lead_htop_raster_100m_punky_clisbako.tif", overwrite=TRUE)

lead_htop_raster_list = list(
  lead_htop_raster_quesnel, lead_htop_raster_gaspard, 
  lead_htop_raster_ahbau, lead_htop_raster_bells, 
  lead_htop_raster_big_valley, lead_htop_raster_cariboo_lake, 
  lead_htop_raster_charleson_marvincreek, lead_htop_raster_dash,
  lead_htop_raster_hawks_creek, lead_htop_raster_little_river,
  lead_htop_raster_little_swift, lead_htop_raster_mcintosh,
  lead_htop_raster_meldrum, lead_htop_raster_phillips_anahim_lake,
  lead_htop_raster_piltz, lead_htop_raster_punky_clisbako)
lead_htop_raster_all = do.call(merge, c(lead_htop_raster_list, tolerance = 1))
lead_htop_rast_all = terra::rast(lead_htop_raster_all)
writeRaster(lead_htop_raster_all, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/lead_htop_raster_100m_allAreas.tif", overwrite=TRUE)
```

```{r, fig.show='hold', out.width="25%", echo=FALSE}
lead_htop_raster_gaspard = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/gaspard/lead_htop_raster_1m_gaspard.tif")
lead_htop_raster_quesnel = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/quesnel/lead_htop_raster_1m_quesnel.tif")
lead_htop_raster_ahbau = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/ahbau/lead_htop_raster_1m_ahbau.tif")
lead_htop_raster_bells = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/bells/lead_htop_raster_1m_bells.tif")
lead_htop_raster_big_valley = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/big_valley/lead_htop_raster_1m_big_valley.tif")
lead_htop_raster_cariboo_lake = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/big_valley/lead_htop_raster_1m_cariboo_lake.tif")
lead_htop_raster_charleson_marvincreek = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/charleson_marvincreek/lead_htop_raster_1m_charleson_marvincreek.tif")
lead_htop_raster_dash = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/bells/lead_htop_raster_1m_dash.tif")
lead_htop_raster_hawks_creek = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/hawks_creek/lead_htop_raster_1m_hawks_creek.tif")
lead_htop_raster_little_river = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/little_river/lead_htop_raster_1m_little_river.tif")
lead_htop_raster_little_swift = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/little_swift/lead_htop_raster_1m_little_swift.tif")
lead_htop_raster_mcintosh = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/mcintosh/lead_htop_raster_1m_mcintosh.tif")
lead_htop_raster_meldrum = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/meldrum/lead_htop_raster_1m_meldrum.tif")
lead_htop_raster_phillips_anahim_lake = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/phillips_anahim_lake/lead_htop_raster_1m_phillips_anahim_lake.tif")
lead_htop_raster_piltz = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/piltz/lead_htop_raster_1m_piltz.tif")
lead_htop_raster_punky_clisbako = raster::raster("/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/punky_clisbako/lead_htop_raster_1m_punky_clisbako.tif")



terra::plot(lead_htop_rast_gaspard, main = 'Gaspard CHM (1m res)')
terra::plot(lead_htop_rast_quesnel, main = 'Quesnel CHM (1m res)')
terra::plot(lead_htop_rast_ahbau, main = 'Ahbau CHM (1m res)')
terra::plot(lead_htop_rast_bells, main = 'Bells CHM (1m res)')
terra::plot(lead_htop_rast_big_valley, main = 'Big Valley CHM (1m res)')
terra::plot(lead_htop_rast_cariboo_lake, main = 'Cariboo Lake CHM (1m res)')
terra::plot(lead_htop_rast_charleson_marvincreek, main = 'Charleson Marvin Creek CHM (1m res)')
terra::plot(lead_htop_rast_dash, main = 'Dash CHM (1m res)')
terra::plot(lead_htop_rast_hawks_creek, main = 'Hawks Creek CHM (1m res)')
terra::plot(lead_htop_rast_little_river, main = 'Little River CHM (1m res)')
terra::plot(lead_htop_rast_little_swift, main = 'Little Swift CHM (1m res)')
terra::plot(lead_htop_rast_mcintosh, main = 'McIntosh CHM (1m res)')
terra::plot(lead_htop_rast_meldrum, main = 'Meldrum CHM (1m res)')
terra::plot(lead_htop_rast_phillips_anahim_lake, main = 'Phillips Anahim Lake CHM (1m res)')
terra::plot(lead_htop_rast_piltz, main = 'Piltz CHM (1m res)')
terra::plot(lead_htop_rast_punky_clisbako, main = 'Punky Clisbako CHM (1m res)')
```

## Import Species Covariate: VRI Fir/Non-Fir rasterization

```{r, eval=FALSE}
lead_htop_sv_quesnel = as.polygons(lead_htop_rast_quesnel)
lead_htop_sv_gaspard = as.polygons(lead_htop_rast_gaspard)
lead_htop_sv_ahbau = as.polygons(lead_htop_rast_ahbau)
lead_htop_sv_bells = as.polygons(lead_htop_rast_bells)
lead_htop_sv_big_valley = as.polygons(lead_htop_rast_big_valley)
lead_htop_sv_cariboo_lake = as.polygons(lead_htop_rast_cariboo_lake)
lead_htop_sv_charleson_marvincreek = as.polygons(lead_htop_rast_charleson_marvincreek)
lead_htop_sv_dash = as.polygons(lead_htop_rast_dash)
lead_htop_sv_hawks_creek = as.polygons(lead_htop_rast_hawks_creek)
lead_htop_sv_little_river = as.polygons(lead_htop_rast_little_river)
lead_htop_sv_little_swift = as.polygons(lead_htop_rast_little_swift)
lead_htop_sv_mcintosh = as.polygons(lead_htop_rast_mcintosh)
lead_htop_sv_meldrum, = as.polygons(lead_htop_rast_meldrum)
lead_htop_sv_phillips_anahim_lake = as.polygons(lead_htop_rast_phillips_anahim_lake)
lead_htop_sv_piltz = as.polygons(lead_htop_rast_piltz)
lead_htop_sv_punky_clisbako = as.polygons(lead_htop_rast_punky_clisbako)

lead_htop_sf_gaspard = sf::st_as_sf(lead_htop_sv_gaspard)
lead_htop_sf_quesnel = sf::st_as_sf(lead_htop_sv_quesnel)
lead_htop_sf_ahbau = sf::st_as_sf(lead_htop_sv_ahbau)
lead_htop_sf_bells = sf::st_as_sf(lead_htop_sv_bells)
lead_htop_sf_big_valley = sf::st_as_sf(lead_htop_sv_big_valley)
lead_htop_sf_cariboo_lake = sf::st_as_sf(lead_htop_sv_cariboo_lake)
lead_htop_sf_charleson_marvincreek = sf::st_as_sf(lead_htop_sv_charleson_marvincreek)
lead_htop_sf_dash = sf::st_as_sf(lead_htop_sv_dash)
lead_htop_sf_hawks_creek = sf::st_as_sf(lead_htop_sv_hawks_creek)
lead_htop_sf_little_river = sf::st_as_sf(lead_htop_sv_little_river)
lead_htop_sf_little_swift = sf::st_as_sf(lead_htop_sv_little_swift)
lead_htop_sf_mcintosh = sf::st_as_sf(lead_htop_sv_mcintosh)
lead_htop_sf_meldrum = sf::st_as_sf(lead_htop_sv_meldrum)
lead_htop_sf_phillips_anahim_lake = sf::st_as_sf(lead_htop_sv_phillips_anahim_lake)
lead_htop_sf_piltz = sf::st_as_sf(lead_htop_sv_piltz)
lead_htop_sf_punky_clisbako = sf::st_as_sf(lead_htop_sv_punky_clisbako)

all_extents_df = full_join(
  as_tibble(lead_htop_sf_quesnel), as_tibble(lead_htop_sf_gaspard), 
  as_tibble(lead_htop_sf_ahbau), as_tibble(lead_htop_sf_bells), 
  as_tibble(lead_htop_sf_big_valley), as_tibble(lead_htop_sf_cariboo_lake), 
  as_tibble(lead_htop_sf_charleson_marvincreek), as_tibble(lead_htop_sf_dash), 
  as_tibble(lead_htop_sf_hawks_creek), as_tibble(lead_htop_sf_little_river), 
  as_tibble(lead_htop_sf_little_swift), as_tibble(lead_htop_sf_mcintosh), 
  as_tibble(lead_htop_sf_meldrum), as_tibble(lead_htop_sf_phillips_anahim_lake), 
  as_tibble(lead_htop_sf_piltz), as_tibble(lead_htop_sf_punky_clisbako), 
  by = "geometry")
all_extents_sf = sf::st_as_sf(lidar_extents_df)

vri_sf = read_sf("/media/seamus/128GB_WORKD/data/vector/vri/vri_bc_2020_rank1.shp")
vri_species = vri_sf[c("SPECIES__1", "SPECIES_CD", "SPECIES_PC")]
vri_species =  dplyr::filter(vri_species, 
    SPECIES__1=='PL' | SPECIES__1=='PLI' | SPECIES__1=='FD' | SPECIES__1=='FDI' |
    SPECIES__1=='SB' | SPECIES__1=='SE' | SPECIES__1=='SW' | SPECIES__1=='SX' | 
    SPECIES__1=='CW' | SPECIES__1=='HW' | SPECIES__1=='BL' | SPECIES__1=='LW')

vri_species_nonFd = vri_species[!(
  vri_species$SPECIES__1 == 'FD' & vri_species$SPECIES_PC >= 50 | vri_species$SPECIES__1 == 'FDI' & vri_species$SPECIES_PC >=50),]
vri_species_nonFd$SPECIES__1 = dplyr::recode(vri_species_nonFd$SPECIES__1, 
  PL = 0, PLI = 0, SB = 1, SE = 1, SW = 1, SX = 1, FD = 2, FDI = 2, CW = 3, HW = 4, BL = 5, LW = 6)
vri_species_nonFd = dplyr::rename(vri_species_nonFd, species_class = SPECIES__1)
vri_species_nonFd = vri_species_nonFd["species_class"]
vri_species_nonFd = sf::st_as_sf(vri_species_nonFd)

vri_species_nonFd = st_intersection(vri_species_nonFd, st_make_valid(all_extents_sf))
species_class_rast_all = terra::rasterize(vect(vri_species_nonFd), lead_htop_rast, field = "species_class", touches = TRUE)
species_class_rast_all = terra::resample(species_class_rast_all, lead_htop_rast)
species_class_raster_all = raster::raster(species_class_rast_all)
raster::writeRaster(species_class_raster_all, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/species_class_raster_100m_allAreas.tif", overwrite=TRUE)
```

## Masking: Generate and merge mask layers

```{r, fig.show='hold', out.width="25%"}
mask_burn2017 = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/TCC_Burn_Severity TCC_Burn_Severity_2017.shp")
mask_burn2018 = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/TCC_Burn_Severity TCC_Burn_Severity_2018.shp")
mask_burn2021 = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/TCC_Burn_Severity TCC_Burn_Severity_2021.shp")
mask_burn2017 = mask_burn2017["BurnSev"]
mask_burn2018 = mask_burn2018["BurnSev"]
mask_burn2021 = mask_burn2021["BurnSev"]
mask_burn2017 = dplyr::filter(mask_burn2017, BurnSev == 'High')
mask_burn2018 = dplyr::filter(mask_burn2018, BurnSev == 'High')
mask_burn2021 = dplyr::filter(mask_burn2021, BurnSev == 'High')
mask_burn2017_quesnel = sf::st_intersection(sf::st_make_valid(mask_burn2017), all_extents_sf)
mask_df_all = full_join(as_tibble(mask_burn2017_gaspard), as_tibble(mask_burn2018_gaspard), as_tibble(mask_burn2021_gaspard), by = "geometry")
mask_sf_all = st_as_sf(mask_df_all) # easier to combine by 'geometry'
ggplot(mask_sf_all) + geom_sf(aes(fill = 'red'), show.legend = FALSE)

mask_clearcut = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/RSLT_CCRES_CLEAR.shp")
mask_clearcut_all = sf::st_intersection(mask_clearcut, st_make_valid(all_extents_sf))
mask_df_all = full_join(as_tibble(mask_sf_all), as_tibble(mask_clearcut_all), by = 'geometry')
mask_sf_all = st_as_sf(mask_df_all)
ggplot(mask_sf_all) + geom_sf(aes(fill = 'red'), show.legend = FALSE)

mask_blocks = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/TCC_Blocks_Join.shp")
mask_blocks_all = sf::st_intersection(mask_blocks, st_make_valid(all_extents_sf))
mask_df_all = full_join(as_tibble(mask_sf_all), as_tibble(mask_blocks_all), by = 'geometry')
ggplot(mask_sf_all) + geom_sf(aes(fill = 'red'), show.legend = FALSE)

mask_roads_tcc = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/TCC_Roads.shp")
mask_roads_tcc = sf::st_zm(mask_roads_tcc)
mask_roads_tcc_all = sf::st_intersection(mask_roads_tcc, st_make_valid(all_extents_sf))
mask_roads_tcc_all = sf::st_buffer(mask_roads_tcc_all, dist = 15, nQuadSegs = 5, endCapStyle = "ROUND", joinStyle = "ROUND", mitreLimit = 2)
mask_roads_ften = sf::read_sf("/media/seamus/128GB_WORKD/data/vector/tcc_mask_layers/FTEN_Roads_All.shp")
mask_roads_ften = sf::st_zm(mask_roads_ften)
mask_roads_ften_all = sf::st_intersection(mask_roads_ften, st_make_valid(all_extents_sf))
mask_roads_ften_all = sf::st_buffer(mask_roads_ften_all, dist = 15, nQuadSegs = 5, endCapStyle = "ROUND", joinStyle = "ROUND", mitreLimit = 2)
mask_df_all = full_join(as_tibble(mask_sf_all), as_tibble(mask_roads_tcc_all), as_tibble(mask_roads_ften_all), by = 'geometry')
mask_sf_all = st_as_sf(mask_df_all)
mask_rast_all = rasterize(vect(mask_sf_all), all_extents_sf, touches = TRUE)
mask_raster_all = raster::raster(mask_rast_all)
writeRaster(mask_raster_all, filename = "/media/seamus/Ubuntu 22_04 LTS amd64/mosaics/mask_raster_100m_all.tif", overwrite=TRUE)
ggplot(mask_sf_all) + geom_sf(aes(fill = 'red'), show.legend = FALSE)
```

## Masking: Apply masking

```{r}
# masking by mask
mask_rast_all = terra::resample(mask_rast_all, lead_htop_rast_all)
mask_rast_all = terra::resample(mask_rast_all, elev_rast_all)
lead_htop_rast_all = mask(lead_htop_rast_all, mask_rast_all, inverse=TRUE)
elev_rast_all = mask(elev_rast_all, mask_rast_all, inverse=TRUE)
species_class_rast_all = mask(species_class_rast_all, mask_rast_all, inverse=TRUE)
# masking by species
lead_htop_rast_all = mask(lead_htop_rast_all, species_class_rast_all, inverse=FALSE)
elev_rast_all = mask(elev_rast_all, species_class_rast_all, inverse=FALSE)

writeRaster(elev_rast_all, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/elev_raster_100m_quesnel.tif", overwrite=TRUE)
writeRaster(elev_rast_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/elev_raster_100m_gaspard.tif", overwrite=TRUE)
writeRaster(slope_rast_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/slope_raster_100m_quesnel.tif", overwrite=TRUE)
writeRaster(slope_rast_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/slope_raster_100m_gaspard.tif", overwrite=TRUE)
writeRaster(asp_cos_rast_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/asp_cos_raster_100m_quesnel.tif", overwrite=TRUE)
writeRaster(asp_cos_rast_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/asp_cos_raster_100m_gaspard.tif", overwrite=TRUE)
writeRaster(asp_sin_rast_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/asp_sin_raster_100m_quesnel.tif", overwrite=TRUE)
writeRaster(asp_sin_rast_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/asp_sin_raster_100m_gaspard.tif", overwrite=TRUE)
writeRaster(species_class_rast_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/species_class_raster_100m_quesnel.tif", overwrite=TRUE)
writeRaster(species_class_rast_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/species_class_raster_100m_gaspard.tif", overwrite=TRUE)
writeRaster(stemsha_L_rast_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/stemsha_L_raster_100m_quesnel.tif", overwrite=TRUE)
writeRaster(stemsha_L_rast_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/stemsha_L_raster_100m_gaspard.tif", overwrite=TRUE)
writeRaster(lead_htop_rast_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/lead_htop_raster_100m_quesnel.tif", overwrite=TRUE)
writeRaster(lead_htop_rast_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/lead_htop_raster_100m_gaspard.tif", overwrite=TRUE)
```

## Tidy: Stack covariates

```{r}
#tidy names
names(elev_rast_quesnel) = "elev"
names(slope_rast_quesnel) = "slope"
names(asp_cos_rast_quesnel) = "asp_cos"
names(asp_sin_rast_quesnel) = "asp_sin"
names(species_class_rast_quesnel) = "species_class"
names(stemsha_L_rast_quesnel) = "stemsha_L"
names(lead_htop_rast_quesnel) = "lead_htop"

names(elev_rast_gaspard) = "elev"
names(slope_rast_gaspard) = "slope"
names(asp_cos_rast_gaspard) = "asp_cos"
names(asp_sin_rast_gaspard) = "asp_sin"
names(species_class_rast_gaspard) = "species_class"
names(stemsha_L_rast_gaspard) = "stemsha_L"
names(lead_htop_rast_gaspard) = "lead_htop"

elev_raster_quesnel = raster::raster(elev_rast_quesnel)
slope_raster_quesnel = raster::raster(slope_rast_quesnel)
asp_cos_raster_quesnel = raster::raster(asp_cos_rast_quesnel)
asp_sin_raster_quesnel = raster::raster(asp_sin_rast_quesnel)
species_class_raster_quesnel = raster::raster(species_class_rast_quesnel)
stemsha_L_raster_quesnel = raster::raster(stemsha_L_rast_quesnel)
lead_htop_raster_quesnel = raster::raster(lead_htop_rast_quesnel)

elev_raster_gaspard = raster::raster(elev_rast_gaspard)
slope_raster_gaspard = raster::raster(slope_rast_gaspard)
asp_cos_raster_gaspard = raster::raster(asp_cos_rast_gaspard)
asp_sin_raster_gaspard = raster::raster(asp_sin_rast_gaspard)
species_class_raster_gaspard = raster::raster(species_class_rast_gaspard)
stemsha_L_raster_gaspard = raster::raster(stemsha_L_rast_gaspard)
lead_htop_raster_gaspard = raster::raster(lead_htop_rast_gaspard)

elev_raster_list = list(elev_raster_quesnel, elev_raster_gaspard)
slope_raster_list = list(slope_raster_quesnel, slope_raster_gaspard)
asp_cos_raster_list = list(asp_cos_raster_quesnel, asp_cos_raster_gaspard)
asp_sin_raster_list = list(asp_sin_raster_quesnel, asp_sin_raster_gaspard)
species_class_raster_list = list(species_class_raster_quesnel, species_class_raster_gaspard)
stemsha_L_raster_list = list(stemsha_L_raster_quesnel, stemsha_L_raster_gaspard)
lead_htop_raster_list = list(lead_htop_raster_quesnel, lead_htop_raster_gaspard)

elev_raster = do.call(merge, c(elev_raster_list, tolerance = 1))
slope_raster = do.call(merge, c(slope_raster_list, tolerance = 1))
asp_cos_raster = do.call(merge, c(asp_cos_raster_list, tolerance = 1))
asp_sin_raster = do.call(merge, c(asp_sin_raster_list, tolerance = 1))
species_class_raster = do.call(merge, c(species_class_raster_list, tolerance = 1))
stemsha_L_raster = do.call(merge, c(stemsha_L_raster_list, tolerance = 1))
lead_htop_raster = do.call(merge, c(lead_htop_raster_list, tolerance = 1))

names(elev_raster) = "elev"
names(slope_raster) = "slope"
names(asp_cos_raster) = "asp_cos"
names(asp_sin_raster) = "asp_sin"
names(species_class_raster) = "species_class"
names(stemsha_L_raster) = "stemsha_L"
names(lead_htop_raster) = "lead_htop"

writeRaster(elev_raster, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/elev_raster_100m_allSites.tif", overwrite=TRUE)
writeRaster(slope_raster, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/slope_raster_100m_allSites.tif", overwrite=TRUE)
writeRaster(asp_cos_raster, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/asp_cos_raster_100m_allSites.tif", overwrite=TRUE)
writeRaster(asp_sin_raster, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/asp_sin_raster_100m_allSites.tif", overwrite=TRUE)
writeRaster(species_class_raster, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/species_class_raster_100m_allSites.tif", overwrite=TRUE)
writeRaster(stemsha_L_raster, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/stemsha_L_raster_100m_allSites.tif", overwrite=TRUE)
writeRaster(lead_htop_raster, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/masked-covariates/lead_htop_raster_100m_allSites.tif", overwrite=TRUE)

covs_m1_quesnel = raster::stack(
  elev_raster_quesnel, 
  slope_raster_quesnel,
  asp_cos_raster_quesnel,
  asp_sin_raster_quesnel,
  species_class_raster_quesnel,
  lead_htop_raster_quesnel)

covs_m2_quesnel = raster::stack(
  elev_raster_quesnel, 
  slope_raster_quesnel,
  asp_cos_raster_quesnel,
  asp_sin_raster_quesnel,
  species_class_raster_quesnel,
  lead_htop_raster_quesnel,
  stemsha_L_raster_quesnel)

covs_m1_gaspard = raster::stack(
  elev_raster_gaspard, 
  slope_raster_gaspard,
  asp_cos_raster_gaspard,
  asp_sin_raster_gaspard,
  species_class_raster_gaspard,
  lead_htop_raster_gaspard)

covs_m2_gaspard = raster::stack(
  elev_raster_gaspard, 
  slope_raster_gaspard,
  asp_cos_raster_gaspard,
  asp_sin_raster_gaspard,
  species_class_raster_gaspard,
  lead_htop_raster_gaspard,
  stemsha_L_raster_gaspard)

covs_m1 = raster::stack(
  elev_raster, 
  slope_raster,
  asp_cos_raster,
  asp_sin_raster,
  lead_htop_raster,
  species_class_raster)

covs_m2 = raster::stack(
  elev_raster, 
  slope_raster,
  asp_cos_raster,
  asp_sin_raster,
  lead_htop_raster,
  species_class_raster,
  stemsha_L_raster)

rasterVis::levelplot(covs_m1_gaspard)
rasterVis::levelplot(covs_m1_quesnel)
```

## Tidy FAIB data: Bootstrapped sampling

```{r, fig.show='hold', out.width="50%"}
faib_psp <- read.csv("/media/seamus/128GB_WORKD/EFI-TCC/0_Caret_Predict_to_writeRasterOutput/Data/FAIB_PSP_20211028.csv")
faib_psp = subset(faib_psp, util == '12.5')
faib_psp$spc_live1 = as.factor(faib_psp$spc_live1)
faib_psp =  subset(faib_psp, 
    spc_live1=='PL' | spc_live1=='PLI' | spc_live1=='FD'| spc_live1=='FDI' | 
    spc_live1=='SB' | spc_live1=='SE' | spc_live1=='SW' | spc_live1=='SX' | 
    spc_live1=='CW' | spc_live1=='HW' | spc_live1=='BL' | spc_live1=='LW')
faib_psp$species_class = dplyr::recode(faib_psp$spc_live1, 
  PL = 1, PLI = 1, SB = 2, SE = 2, SX = 2, 
  FD = 3, FDI = 3, CW = 3, HW = 4, BL = 5, LW = 6)
faib_psp$asp_cos = cos((faib_psp$aspect * pi) / 180)
faib_psp$asp_sin = sin((faib_psp$aspect * pi) / 180)
faib_psp = faib_psp[c("elev", "slope", "asp_cos", "asp_sin", "lead_htop", "species_class", "stemsha_L", "wsvha_L")]
faib_psp$elev[faib_psp$elev <= 0] = NA
faib_psp$slope[faib_psp$slope <= 0] = NA
faib_psp$lead_htop[faib_psp$lead_htop < 2] = NA
faib_psp$stemsha_L[faib_psp$stemsha_L <= 0] = NA
faib_psp$wsvha_L[faib_psp$wsvha_L <= 1] = NA
faib_psp = subset(faib_psp, stemsha_L < 864)
faib_psp = na.omit(faib_psp)
psych::describe(faib_psp)
stemsha_L_raster_df = as.data.frame(rasterToPoints(stemsha_L_raster_gaspard))
dist.fun = approxfun(density(stemsha_L_raster_df$stemsha_L))
faib_psp = dplyr::sample_n(faib_psp, B * n, weight_by = dist.fun(faib_psp$stemsha_L), replace = TRUE)
faib_psp = dplyr::sample_n(faib_psp, 600, weight_by = dist.fun, replace = TRUE)
truehist(faib_psp$stemsha_L, main="Stems/ha (Bootstrapped FAIB)")
```

## Tidy plot data: Data cleaning & training-test split

```{r}
faib_psp$elev = as.numeric(faib_psp$elev)
faib_psp$slope = as.numeric(faib_psp$slope)
faib_psp$asp_cos = as.numeric(faib_psp$asp_cos)
faib_psp$asp_sin = as.numeric(faib_psp$asp_sin)
faib_psp$lead_htop = as.numeric(faib_psp$lead_htop)
faib_psp$species_class = as.numeric(faib_psp$species_class)
faib_psp$stemsha_L = as.numeric(faib_psp$stemsha_L)
faib_psp$wsvha_L = as.numeric(faib_psp$wsvha_L)
faib_vri_true_m1_df = faib_psp[c("elev", "slope", "asp_cos", "asp_sin", "lead_htop", "species_class", "wsvha_L")] 
faib_vri_true_m2_df = faib_psp[c("elev", "slope", "asp_cos", "asp_sin", "lead_htop", "species_class", "stemsha_L", "wsvha_L")]
faib_vri_true_m1_df = na.omit(faib_vri_true_m1_df)
faib_vri_true_m2_df = na.omit(faib_vri_true_m2_df)

n <- nrow(faib_vri_true_m2_df)
frac <- 0.8
ix <- sample(n, frac * n)
train_m1 = faib_vri_true_m1_df[ix,]
test_m1 = faib_vri_true_m1_df[-ix,]
train_m2 = faib_vri_true_m2_df[ix,]
test_m2 = faib_vri_true_m2_df[-ix,]

X_train_m1=train_m1[,-7]
X_test_m1=test_m1[,-7]
y_train_m1=train_m1[,7]
y_test_m1=test_m1[,7]

X_train_m2=train_m2[,-8]
X_test_m2=test_m2[,-8]
y_train_m2=train_m2[,8]
y_test_m2=test_m2[,8]

X_m1 = faib_vri_true_m1_df[,-7]
y_m1 = faib_vri_true_m1_df[,7]
X_m2 = faib_vri_true_m2_df[,-8]
y_m2 = faib_vri_true_m2_df[,8]
```

## Exploratory data analysis: Comparing distributions

```{r, fig.show='hold', out.width="25%"}
library(MASS)
truehist(faib_vri_true_m1_df$elev, main="DEM (FAIB)")
hist(elev_raster, main="DEM (all sites)", maxpixels=22000000)
hist(elev_raster_gaspard, main="DEM (Gaspard)", maxpixels=22000000)
hist(elev_raster_quesnel, main="DEM (Quesnel)", maxpixels=22000000)
truehist(faib_vri_true_m1_df$slope, main="Slope (FAIB)")
hist(slope_raster, main="Slope (all sites)", maxpixels=22000000) 
hist(slope_raster_gaspard, main="Slope (Gaspard)", maxpixels=22000000) 
hist(slope_raster_quesnel, main="Slope (Quesnel)", maxpixels=22000000) 
truehist(faib_vri_true_m1_df$asp_cos, main="Northness (FAIB)")
hist(asp_cos_raster, main="Northness (all sites)", maxpixels=22000000)
hist(asp_cos_raster_gaspard, main="Northness (Gaspard)", maxpixels=22000000)
hist(asp_cos_rast_quesnel, main="Northness (Quesnel)", maxpixels=22000000)
truehist(faib_vri_true_m1_df$asp_cos, main="Eastness (FAIB)")
hist(asp_cos_raster, main="Eastness (all sites)", maxpixels=22000000)
hist(asp_cos_raster_gaspard, main="Eastness (Gaspard)", maxpixels=22000000)
hist(asp_cos_rast_quesnel, main="Eastness (Quesnel)", maxpixels=22000000)
truehist(faib_vri_true_m2_df$stemsha_L, main="Stems/ha (FAIB)")
hist(stemsha_L_raster, main="Stems/ha (all sites)", maxpixels=22000000)
hist(stemsha_L_raster_gaspard, main="Stems/ha (Gaspard)", maxpixels=22000000)
hist(stemsha_L_raster_quesnel, main="Stems/ha (Quesnel)", maxpixels=22000000)
faib_vri_true_m1_df$species_class = as.numeric(faib_vri_true_m1_df$species_class)
truehist(faib_vri_true_m1_df$species_class, main="Lead Species (FAIB)")
hist(species_class_raster, main="Lead Species (all sites)", maxpixels=22000000)
hist(species_class_raster_gaspard, main="Lead Species (Gaspard)", maxpixels=22000000)
hist(species_class_raster_quesnel, main="Lead Species (Quesnel)", maxpixels=22000000)
truehist(faib_vri_true_m1_df$lead_htop, main="CHM 95th% (FAIB)")
hist(lead_htop_raster, main="CHM 95th% (all sites)", maxpixels=22000000) 
hist(lead_htop_raster_gaspard, main="CHM 95th% (Gaspard)", maxpixels=22000000) 
hist(lead_htop_raster_quesnel, main="CHM 95th% (Quesnel)", maxpixels=22000000) 
```

## Exploratory data analysis: Visualize trends in variance

```{r, fig.show='hold', out.width="25%"}
elev_wsvha_lm = lm(wsvha_L ~ elev, data = faib_vri_true_m1_df)
slope_wsvha_lm = lm(wsvha_L ~ slope, data = faib_vri_true_m1_df)
asp_cos_wsvha_lm = lm(wsvha_L ~ asp_cos, data = faib_vri_true_m1_df)
asp_sin_wsvha_lm = lm(wsvha_L ~ asp_sin, data = faib_vri_true_m1_df)
lead_htop_wsvha_lm = lm(wsvha_L ~ lead_htop, data = faib_vri_true_m1_df)
species_class_wsvha_lm = lm(wsvha_L ~ species_class, data = faib_vri_true_m1_df)
stemsha_L_wsvha_lm = lm(wsvha_L ~ stemsha_L, data = faib_vri_true_m2_df)

summary(elev_wsvha_lm)
truehist(faib_vri_true_m1_df$elev)
truehist(elev_wsvha_lm$residuals)
plot(wsvha_L ~ elev, data = faib_vri_true_m1_df,
     main="Linear function showing negative correlation:\nR^2=0.011, =-0.0954, p<0.0000",
     col="blue", pch=20, cex=0.5, cex.main=0.6, cex.lab=0.8, cex.axis=0.8, adj=1,
     ylab = "wsvha_L (m3/ha)", xlab = "DEM")
abline(elev_wsvha_lm, col = "red")
plot(elev_wsvha_lm, which=1, 
     main="Residuals showing increasing trend\n clustering at larger fitted values", 
     col="blue", pch=20, cex=0.5, cex.main=0.6, cex.lab=0.5, cex.axis=0.5, adj=1) # Residuals vs Fitted Plot
summary(slope_wsvha_lm)
truehist(faib_vri_true_m1_df$slope)
truehist(slope_wsvha_lm$residuals)
plot(wsvha_L ~ slope, data = faib_vri_true_m1_df,
     main="Linear function showing negative correlation:\nR^2=0.0013, =-0.5171: p=0.0009", 
     col="blue", pch=20, cex=0.5, cex.main=0.6, cex.lab=0.8, cex.axis=0.8, adj=1,
     ylab = "wsvha_L (m3/ha)", xlab = "slope")
abline(slope_wsvha_lm, col = "red")
plot(slope_wsvha_lm, which=1, 
     main="Residuals showing increasing trend of\nnegative errors near larger fitted values", 
     col="blue", pch=20, cex=0.5, cex.main=0.6, cex.lab=0.5, cex.axis=0.5, adj=1) 
summary(asp_cos_wsvha_lm)
truehist(faib_vri_true_m1_df$asp_cos)
truehist(asp_cos_wsvha_lm$residuals)
plot(wsvha_L ~ asp_cos, data = faib_vri_true_m1_df,
     main="Linear function showing positive correlation:\nR^2=0.005, =15.197, p<0.000",
     col="blue", pch=20, cex=0.5, cex.main=0.6, cex.lab=0.8, cex.axis=0.8, adj=1,
     ylab = "wsvha_L (m3/ha)", xlab = "asp_cos")
abline(asp_cos_wsvha_lm, col = "red")
plot(asp_cos_wsvha_lm, which=1, 
     main="Residuals showing almost constant variance", 
     col="blue", pch=20, cex=0.5, cex.main=0.6, cex.lab=0.5, cex.axis=0.5, adj=1) 
summary(asp_sin_wsvha_lm)
truehist(faib_vri_true_m1_df$asp_sin)
truehist(asp_sin_wsvha_lm$residuals)
plot(wsvha_L ~ asp_sin, data = faib_vri_true_m1_df,
     main="Linear function showing positive correlation:\nR^2=0.005, =15.197, p<0.000",
     col="blue", pch=20, cex=0.5, cex.main=0.6, cex.lab=0.8, cex.axis=0.8, adj=1,
     ylab = "wsvha_L (m3/ha)", xlab = "asp_sin")
abline(asp_sin_wsvha_lm, col = "red")
plot(asp_sin_wsvha_lm, which=1, 
     main="Residuals showing almost constant variance", 
     col="blue", pch=20, cex=0.5, cex.main=0.6, cex.lab=0.5, cex.axis=0.5, adj=1) 
summary(lead_htop_wsvha_lm)
truehist(faib_vri_true_m1_df$lead_htop)
truehist(lead_htop_wsvha_lm$residuals)
plot(wsvha_L ~ lead_htop, data = faib_vri_true_m1_df,
     main="Linear function shows positive correlation:\n R^2=0.6508, =20.6829, p<0.0000",
     col="blue", pch=20, cex=0.5, cex.main=0.6, cex.lab=0.8, cex.axis=0.8, adj=1,
     ylab = "wsvha_L (m3/ha)", xlab = "lead_htop")
abline(lead_htop_wsvha_lm, col = "red")
plot(lead_htop_wsvha_lm, which=1, 
     main="Residuals showing non-constant variance with\n increasing trends at smallest and largest fitted values", 
     col="blue", pch=20, cex=0.5, cex.main=0.6, cex.lab=0.5, cex.axis=0.5, adj=1) 
summary(stemsha_L_wsvha_lm)
truehist(faib_vri_true_m2_df$stemsha_L)
truehist(stemsha_L_wsvha_lm$residuals)
plot(wsvha_L ~ stemsha_L, data = faib_vri_true_m2_df,
     main="No significant relationship with response variable:\nR^2=0.0001, =-0.0008, p<0.4743",
     col="blue", pch=20, cex=0.5, cex.main=0.6, cex.lab=0.5, cex.axis=0.5, adj=1,
     ylab = "wsvha_L (m3/ha)", xlab = "stemsha_L")
abline(stemsha_L_wsvha_lm, col = "red")
plot(stemsha_L_wsvha_lm, which=1, 
     main="Residuals showing non-constant variance with negative\nand positive errors clusters at larger fitted values", 
     col="blue", pch=20, cex=0.5, cex.main=0.6, cex.lab=0.5, cex.axis=0.5, adj=1) 
wsvha_L_lm = lm(wsvha_L ~ ., data = faib_vri_true_m1_df)
truehist(faib_vri_true_m1_df$wsvha_L)
truehist(wsvha_L_lm$residuals)
plot(wsvha_L_lm$residuals,
     main="",
     col="blue", pch=20, cex=0.8, cex.main=0.8, cex.lab=0.8, cex.axis=0.8, adj=1,
     ylab = "wsvha_L (m3/ha)", xlab = "predictors")     
abline(wsvha_L_lm, col="red")
summary(species_class_wsvha_lm)
faib_vri_true_m1_df$species_class = as.numeric(faib_vri_true_m1_df$species_class)
truehist(faib_vri_true_m1_df$species_class)
truehist(species_class_wsvha_lm$residuals)
plot(species_class_wsvha_lm, which=1, 
     main="Residuals showing decreasing trend with True-fir group:\nR^2=0.0025, =6.584, p<0.000", 
     col="blue", pch=20, cex=0.5, cex.main=0.6, cex.lab=0.5, cex.axis=0.5, adj=1) 
car::residualPlots(elev_wsvha_lm, terms= ~ 1 | species_class, cex=0.1, pch=19) # plot vs. yhat grouping by type
```

## Model: Random Forest Tree Regression

```{r, eval=FALSE}
tuneResult_rf_m1_full <- tune.randomForest(
  X_m1, y_m1,
  mtry = c(2:10), ntree = 50,
  tunecontrol = tune.control(sampling = "cross", cross = 10),
  preProcess = c("BoxCox","center","scale"))

tuneResult_rf_m2_full <- tune.randomForest(
  X_m2, y_m2,
  mtry = c(2:10), ntree = 50,
  tunecontrol = tune.control(sampling = "cross", cross = 10),
  preProcess = c("BoxCox","center","scale"))

tunedModel_rf_m1_full <- tuneResult_rf_m1_full$best.model
tunedModel_rf_m2_full <- tuneResult_rf_m2_full$best.model
save(tunedModel_rf_m1_full, file = "/media/seamus/128GB_WORKD/data/models/tcc-wsvha/wsvha_model1_randomForest.RData")
save(tunedModel_rf_m2_full, file = "/media/seamus/128GB_WORKD/data/models/tcc-wsvha/wsvha_model2_randomForest.RData")
tunedModel_rf_m1 = predict(tunedModel_rf_m1_full, X_m1, y_m1, type = "response")
tunedModel_rf_m2 = predict(tunedModel_rf_m2_full, X_m2, y_m2, type = "response")

tuneResult_rf_m1_train <- tune.randomForest(
  X_train_m1, y_train_m1, 
  mtry = c(2:10), ntree = 50,
  tunecontrol = tune.control(sampling = "cross", cross = 10), 
  preProcess = c("BoxCox","center","scale"))

tuneResult_rf_m2_train <- tune.randomForest(
  X_train_m2, y_train_m2, 
  mtry = c(2:10), ntree = 50, 
  tunecontrol = tune.control(sampling = "cross", cross = 10), 
  preProcess = c("BoxCox","center","scale"))

tunedModel_rf_m1_train <- tuneResult_rf_m1_train$best.model
tunedModel_rf_m2_train <- tuneResult_rf_m2_train$best.model
tunedModel_rf_m1_test = predict(tunedModel_rf_m1_train, X_test_m1, y_test_m1, type="response")
tunedModel_rf_m2_test = predict(tunedModel_rf_m2_train, X_test_m2, y_test_m2, type="response")
tunedModel_rf_m1_full_MAE = MAE(tunedModel_rf_m1, y_m2)
tunedModel_rf_m1_full_RMSE = RMSE(tunedModel_rf_m1, y_m2)
tunedModel_rf_m2_full_MAE = MAE(tunedModel_rf_m2, y_m2)
tunedModel_rf_m2_full_RMSE = RMSE(tunedModel_rf_m2, y_m2)
tunedModel_rf_m1_test_MAE = MAE(tunedModel_rf_m1_test, y_test_m2)
tunedModel_rf_m1_test_RMSE = RMSE(tunedModel_rf_m1_test, y_test_m2)
tunedModel_rf_m2_test_MAE = MAE(tunedModel_rf_m2_test, y_test_m2)
tunedModel_rf_m2_test_RMSE = RMSE(tunedModel_rf_m2_test, y_test_m2)

R2(tunedModel_rf_m1, y_m1)
MAE(tunedModel_rf_m1, y_m1)
RMSE(tunedModel_rf_m1, y_m1)
MAE(tunedModel_rf_m1_test, y_test_m1)
RMSE(tunedModel_rf_m1_test, y_test_m1)
tunedModel_rf_m1_full_RMSE/tunedModel_rf_m1_test_RMSE

R2(tunedModel_rf_m2, y_m2)
MAE(tunedModel_rf_m2, y_m2)
RMSE(tunedModel_rf_m2, y_m2)
MAE(tunedModel_rf_m2_test, y_test_m2)
RMSE(tunedModel_rf_m2_test, y_test_m2)
tunedModel_rf_m2_full_RMSE/tunedModel_rf_m2_test_RMSE

tunedModel_rf_m1_to_raster <- predict(covs_m1, tunedModel_rf_m1_full)
tunedModel_rf_m2_to_raster <- predict(covs_m2, tunedModel_rf_m2_full)
tunedModel_rf_m1_to_raster_gaspard <- predict(covs_m1_gaspard, tunedModel_rf_m1_full)
tunedModel_rf_m2_to_raster_gaspard <- predict(covs_m2_gaspard, tunedModel_rf_m2_full)
tunedModel_rf_m1_to_raster_quesnel <- predict(covs_m1_quesnel, tunedModel_rf_m1_full)
tunedModel_rf_m2_to_raster_quesnel <- predict(covs_m2_quesnel, tunedModel_rf_m2_full)
writeRaster(tunedModel_rf_m2_to_raster, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/wsvha_model2_randomForest_100m_allAreas.tif", overwrite=TRUE)
writeRaster(tunedModel_rf_m1_to_raster, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/wsvha_model1_randomForest_100m_allAreas.tif", overwrite=TRUE)
writeRaster(tunedModel_rf_m2_to_raster_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_randomForest_100m_gaspard.tif", overwrite=TRUE)
writeRaster(tunedModel_rf_m1_to_raster_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_randomForest_100m_gaspard.tif", overwrite=TRUE)
writeRaster(tunedModel_rf_m2_to_raster_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_randomForest_100m_quesnel.tif", overwrite=TRUE)
writeRaster(tunedModel_rf_m1_to_raster_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_randomForest_100m_quesnel.tif", overwrite=TRUE)
```

```{r, fig.show='hold', out.width="25%", echo=FALSE}
wsvha_model1_randomForest_100m_gaspard = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_randomForest_100m_gaspard.tif")
wsvha_model2_randomForest_100m_gaspard = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_randomForest_100m_gaspard.tif")
wsvha_model1_randomForest_100m_quesnel = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_randomForest_100m_quesnel.tif")
wsvha_model2_randomForest_100m_quesnel = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_randomForest_100m_quesnel.tif")
plot(wsvha_model1_randomForest_100m_gaspard, main="Model1 NO-STEMS (Random Forest)", cex.main=0.8, maxpixels=22000000)
plot(wsvha_model1_randomForest_100m_quesnel, main="Model1 NO-STEMS (Random Forest)", cex.main=0.8, maxpixels=22000000)
plot(wsvha_model2_randomForest_100m_gaspard, main="Model2 WITH-STEMS (Random Forest)", cex.main=0.8, maxpixels=22000000)
plot(wsvha_model2_randomForest_100m_quesnel, main="Model2 WITH-STEMS (Random Forest)", cex.main=0.8, maxpixels=22000000)
hist(wsvha_model1_randomForest_100m_gaspard, main="Model1 NO-STEMS (Random Forest)", cex.main=0.8, maxpixels=22000000) 
hist(wsvha_model1_randomForest_100m_quesnel, main="Model1 NO-STEMS (Random Forest)", cex.main=0.8, maxpixels=22000000) 
hist(wsvha_model2_randomForest_100m_gaspard, main="Model2 WITH-STEMS (Random Forest)", cex.main=0.8, maxpixels=22000000) 
hist(wsvha_model2_randomForest_100m_quesnel, main="Model2 WITH-STEMS (Random Forest)", cex.main=0.8, maxpixels=22000000) 
```

## Model: Support Vector Machine Radial Kernel (epsilon-untuned)

```{r, eval=FALSE}
fitControl_YeoJx1 = caret::trainControl(method="repeatedcv", number=10, repeats=1)
fitControl_YeoJx3 = caret::trainControl(method="repeatedcv", number=10, repeats=3)
fitControl_YeoJx5 = caret::trainControl(method="repeatedcv", number=10, repeats=5)
fitControl_YeoJx10 = caret::trainControl(method="repeatedcv", number=10, repeats=10)

tuneResult_svm_m1_full <- train(wsvha_L~., data=faib_vri_true_m1_df,
  trControl = fitControl_YeoJx10,
  method = 'svmRadial',
  metric = 'RMSE',
  ranges = list(
    cost = c(1,5,7,15,20), 
    gamma = 2^(-1:1)),
  tuneLength = 10,
  preProc = c('YeoJohnson', 'scale', 'center', 'corr'),
  verbose=F)

tuneResult_svm_m2_full <- train(wsvha_L~., data=faib_vri_true_m2_df,
  trControl = fitControl_YeoJx10,
  method = 'svmRadial',
  metric = 'RMSE',
  ranges = list(
    cost = c(1,5,7,15,20), 
    gamma = 2^(-1:1)),
  tuneLength = 10,
  preProc = c('YeoJohnson', 'scale', 'center', 'corr'),
  verbose=F)

tunedModel_svm_m1_full <- tuneResult_svm_m1_full$finalModel
tunedModel_svm_m2_full <- tuneResult_svm_m2_full$finalModel
save(tunedModel_svm_m1_full, file = "/media/seamus/128GB_WORKD/data/models/tcc-wsvha/wsvha_model1_svmRadial.RData")
save(tunedModel_svm_m2_full, file = "/media/seamus/128GB_WORKD/data/models/tcc-wsvha/wsvha_model2_svmRadial.RData")

tuneResult_svm_m1_train <- train(
  X_train_m1, y_train_m1,
  trControl = fitControl_YeoJx10,
  method = 'svmRadial',
  metric = 'RMSE',
  ranges = list(
    cost = c(1,5,7,15,20), 
    gamma = 2^(-1:1)),
  tuneLength = 10,
  preProc = c('YeoJohnson', 'scale', 'center', 'corr'),
  verbose=F)

tuneResult_svm_m2_train <- train(
  X_train_m2, y_train_m2,
  trControl = fitControl_YeoJx10,
  method = 'svmRadial',
  metric = 'RMSE',
  ranges = list(
    cost = c(1,5,7,15,20), 
    gamma = 2^(-1:1)),
  tuneLength = 10,
  preProc = c('YeoJohnson', 'scale', 'center', 'corr'),
  verbose=F)

tunedModel_svmRadial_m1_test = predict(tuneResult_svm_m1_train, data = test_m1)
tunedModel_svmRadial_m2_test = predict(tuneResult_svm_m2_train, data = test_m2)
tunedModel_svmRadial_m1_test_MAE = MAE(tunedModel_svmRadial_m1_test, test_m1$wsvha_L)
tunedModel_svmRadial_m2_test_MAE = MAE(tunedModel_svmRadial_m2_test, test_m2$wsvha_L)
tunedModel_svmRadial_m1_test_RMSE = RMSE(tunedModel_svmRadial_m1_test, test_m1$wsvha_L)
tunedModel_svmRadial_m2_test_RMSE = RMSE(tunedModel_svmRadial_m2_test, test_m2$wsvha_L)

tunedModel_svmRadial_m1 = predict(tuneResult_svm_m1_full, data = faib_vri_true_m1_df)
tunedModel_svmRadial_m2 = predict(tuneResult_svm_m2_full, data = faib_vri_true_m2_df)
tunedModel_svmRadial_m1_MAE = MAE(tunedModel_svmRadial_m1, faib_vri_true_m1_df$wsvha_L)
tunedModel_svmRadial_m2_MAE = MAE(tunedModel_svmRadial_m2, faib_vri_true_m2_df$wsvha_L)
tunedModel_svmRadial_m1_RMSE = RMSE(tunedModel_svmRadial_m1, faib_vri_true_m1_df$wsvha_L)
tunedModel_svmRadial_m2_RMSE = RMSE(tunedModel_svmRadial_m2, faib_vri_true_m2_df$wsvha_L)

tunedModel_rf_m1_train <- tuneResult_rf_m1_train$best.model
tunedModel_rf_m2_train <- tuneResult_rf_m2_train$best.model
tunedModel_rf_m1_test = predict(tunedModel_rf_m1_train, X_test_m1, y_test_m1, type="response")
tunedModel_rf_m2_test = predict(tunedModel_rf_m2_train, X_test_m2, y_test_m2, type="response")
tunedModel_rf_m1_full_MAE = MAE(tunedModel_rf_m1, y_m2)
tunedModel_rf_m1_full_RMSE = RMSE(tunedModel_rf_m1, y_m2)
tunedModel_rf_m2_full_MAE = MAE(tunedModel_rf_m2, y_m2)
tunedModel_rf_m2_full_RMSE = RMSE(tunedModel_rf_m2, y_m2)
tunedModel_rf_m1_test_MAE = MAE(tunedModel_rf_m1_test, y_test_m2)
tunedModel_rf_m1_test_RMSE = RMSE(tunedModel_rf_m1_test, y_test_m2)
tunedModel_rf_m2_test_MAE = MAE(tunedModel_rf_m2_test, y_test_m2)
tunedModel_rf_m2_test_RMSE = RMSE(tunedModel_rf_m2_test, y_test_m2)

tunedModel_svmRadial_m2_MAE
tunedModel_svmRadial_m2_RMSE 
tunedModel_svmRadial_m2_test_MAE
tunedModel_svmRadial_m2_test_RMSE
tunedModel_svmRadial_m2_RMSE/tunedModel_svmRadial_m2_test_RMSE

tunedModel_svmRadial_m1_MAE
tunedModel_svmRadial_m1_RMSE 
tunedModel_svmRadial_m1_test_MAE
tunedModel_svmRadial_m1_test_RMSE
tunedModel_svmRadial_m1_RMSE/tunedModel_svmRadial_m1_test_RMSE


tunedModel_svm_m1_to_raster <- raster::predict(covs_m1, tuneResult_svm_m1_full)
tunedModel_svm_m2_to_raster <- raster::predict(covs_m2, tuneResult_svm_m2_full)
tunedModel_svm_m1_to_raster_gaspard <- raster::predict(covs_m1_gaspard, tuneResult_svm_m1_full)
tunedModel_svm_m2_to_raster_gaspard <- raster::predict(covs_m2_gaspard, tuneResult_svm_m2_full)
tunedModel_svm_m1_to_raster_quesnel <- raster::predict(covs_m1_quesnel, tuneResult_svm_m1_full)
tunedModel_svm_m2_to_raster_quesnel <- raster::predict(covs_m2_quesnel, tuneResult_svm_m2_full)
save(tunedModel_svm_m1_full, file = "/media/seamus/128GB_WORKD/data/models/tcc-wsvha/wsvha_model1_svmRadial.RData")
save(tunedModel_svm_m2_full, file = "/media/seamus/128GB_WORKD/data/models/tcc-wsvha/wsvha_model2_svmRadial.RData")
tunedModel_svm_m1_to_raster$layer[tunedModel_svm_m1_to_raster$layer <= 0] = 0
tunedModel_svm_m2_to_raster$layer[tunedModel_svm_m2_to_raster$layer <= 0] = 0
tunedModel_svm_m1_to_raster_gaspard$layer[tunedModel_svm_m1_to_raster_gaspard$layer <= 0] = 0
tunedModel_svm_m2_to_raster_gaspard$layer[tunedModel_svm_m2_to_raster_gaspard$layer <= 0] = 0
tunedModel_svm_m1_to_raster_quesnel$layer[tunedModel_svm_m1_to_raster_quesnel$layer <= 0] = 0
tunedModel_svm_m2_to_raster_quesnel$layer[tunedModel_svm_m2_to_raster_quesnel$layer <= 0] = 0
writeRaster(tunedModel_svm_m1_to_raster, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmRadial_100m_allAreas.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m2_to_raster, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmRadial_100m_allAreas.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m1_to_raster_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmRadial_100m_gaspard.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m2_to_raster_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmRadial_100m_gaspard.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m1_to_raster_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmRadial_100m_quesnel.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m2_to_raster_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmRadial_100m_quesnel.tif", overwrite=TRUE)
```

```{r, fig.show='hold', out.width="25%", echo=FALSE}
wsvha_model1_svmRadial_100m_gaspard = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmRadial_100m_gaspard.tif")
wsvha_model2_svmRadial_100m_gaspard = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmRadial_100m_gaspard.tif")
wsvha_model1_svmRadial_100m_quesnel = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmRadial_100m_quesnel.tif")
wsvha_model2_svmRadial_100m_quesnel = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmRadial_100m_quesnel.tif")
plot(wsvha_model1_svmRadial_100m_gaspard, main="Model1 NO-STEMS (SVM Radial)", cex.main=0.8, maxpixels=22000000)
plot(wsvha_model1_svmRadial_100m_quesnel, main="Model1 NO-STEMS (SVM Radial)", cex.main=0.8, maxpixels=22000000)
plot(wsvha_model2_svmRadial_100m_gaspard, main="Model2 WITH-STEMS (SVM Radial)", cex.main=0.8, maxpixels=22000000)
plot(wsvha_model2_svmRadial_100m_quesnel, main="Model2 WITH-STEMS (SVM Radial)", cex.main=0.8, maxpixels=22000000)
hist(wsvha_model1_svmRadial_100m_gaspard, main="Model1 NO-STEMS (SVM Radial)", cex.main=0.8, maxpixels=22000000) 
hist(wsvha_model1_svmRadial_100m_quesnel, main="Model1 NO-STEMS (SVM Radial)", cex.main=0.8, maxpixels=22000000) 
hist(wsvha_model2_svmRadial_100m_gaspard, main="Model2 WITH-STEMS (SVM Radial)", cex.main=0.8, maxpixels=22000000) 
hist(wsvha_model2_svmRadial_100m_quesnel, main="Model2 WITH-STEMS (SVM Radial)", cex.main=0.8, maxpixels=22000000) 
```

## Model: Support Vector Machine Radial Kernel (epsilon-tuned)

```{r, eval=FALSE}
tuneResult_svm_m1_full_eps <- train(
  X_m1, y_m1, 
  trControl = fitControl_YeoJx10,
  method = 'svmRadial', metric = 'RMSE',
  ranges = list(epsilon = seq(0.02,0.1,0.2), cost = c(1,5,7,15,20), gamma = 2^(-1:1)), tuneLength = 10,
  preProc = c('YeoJohnson', 'scale', 'center', 'corr'),
  verbose=F)

tuneResult_svm_m2_full_eps = train(
  X_m2, y_m2,
  trControl = fitControl_YeoJx10,
  method = 'svmRadial', metric = 'RMSE',
  ranges = list(epsilon = seq(0.02,0.1,0.2), cost = c(1,5,7,15,20), gamma = 2^(-1:1)),tuneLength = 10,
  preProc = c('YeoJohnson', 'scale', 'center', 'corr'),
  verbose=F)

tunedModel_svm_m2_full_eps <- tuneResult_svm_m2_full_eps$finalModel
tunedModel_svm_m1_full_eps <- tuneResult_svm_m1_full_eps$finalModel
save(tunedModel_svm_m1_full_eps, file = "/media/seamus/128GB_WORKD/data/models/tcc-wsvha/wsvha_model1_svmRadial_e.RData")
save(tunedModel_svm_m2_full_eps, file = "/media/seamus/128GB_WORKD/data/models/tcc-wsvha/wsvha_model2_svmRadial_e.RData")
tunedModel_svm_m1_to_raster_eps <- raster::predict(covs_m1, tuneResult_svm_m1_full_eps)
tunedModel_svm_m2_to_raster_eps <- raster::predict(covs_m2, tuneResult_svm_m2_full_eps)
tunedModel_svm_m1_to_raster_eps_gaspard <- raster::predict(covs_m1_gaspard, tuneResult_svm_m1_full_eps)
tunedModel_svm_m2_to_raster_eps_gaspard <- raster::predict(covs_m2_gaspard, tuneResult_svm_m2_full_eps)
tunedModel_svm_m1_to_raster_eps_quesnel <- raster::predict(covs_m1_quesnel, tuneResult_svm_m1_full_eps)
tunedModel_svm_m2_to_raster_eps_quesnel <- raster::predict(covs_m2_quesnel, tuneResult_svm_m2_full_eps)
tunedModel_svm_m1_to_raster_eps$layer[tunedModel_svm_m1_to_raster_eps$layer <= 0] = 0
tunedModel_svm_m2_to_raster_eps$layer[tunedModel_svm_m2_to_raster_eps$layer <= 0] = 0
tunedModel_svm_m1_to_raster_eps_gaspard$layer[tunedModel_svm_m1_to_raster_eps_gaspard$layer <= 0] = 0
tunedModel_svm_m2_to_raster_eps_gaspard$layer[tunedModel_svm_m2_to_raster_eps_gaspard$layer <= 0] = 0
tunedModel_svm_m1_to_raster_eps_quesnel$layer[tunedModel_svm_m1_to_raster_eps_quesnel$layer <= 0] = 0
tunedModel_svm_m2_to_raster_eps_quesnel$layer[tunedModel_svm_m2_to_raster_eps_quesnel$layer <= 0] = 0
writeRaster(tunedModel_svm_m1_to_raster_eps, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmRadial_e_100m_allAreas.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m2_to_raster_eps, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmRadial_e_100m_allAreas.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m1_to_raster_eps_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmRadial_e_100m_gaspard.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m2_to_raster_eps_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmRadial_e_100m_gaspard.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m1_to_raster_eps_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmRadial_e_100m_quesnel.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m2_to_raster_eps_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmRadial_e_100m_quesnel.tif", overwrite=TRUE)
```

```{r, fig.show='hold', out.width="25%", echo=FALSE}
wsvha_model1_svmRadial_e_100m_gaspard = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmRadial_e_100m_gaspard.tif")
wsvha_model2_svmRadial_e_100m_gaspard = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmRadial_e_100m_gaspard.tif")
wsvha_model1_svmRadial_e_100m_quesnel = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmRadial_e_100m_quesnel.tif")
wsvha_model2_svmRadial_e_100m_quesnel = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmRadial_e_100m_quesnel.tif")
plot(wsvha_model1_svmRadial_e_100m_gaspard, main="Model1 NO-STEMS (SVM Radial epsilon-tuned)", cex.main=0.8, maxpixels=22000000)
plot(wsvha_model1_svmRadial_e_100m_quesnel, main="Model1 NO-STEMS (SVM Radial epsilon-tuned)", cex.main=0.8, maxpixels=22000000)
plot(wsvha_model2_svmRadial_e_100m_gaspard, main="Model2 WITH-STEMS (SVM Radial epsilon-tuned)", cex.main=0.8, maxpixels=22000000)
plot(wsvha_model2_svmRadial_e_100m_quesnel, main="Model2 WITH-STEMS (SVM Radial epsilon-tuned)", cex.main=0.8, maxpixels=22000000)
hist(wsvha_model1_svmRadial_e_100m_gaspard, main="Model1 NO-STEMS (SVM Radial epsilon-tuned)", cex.main=0.8, maxpixels=22000000) 
hist(wsvha_model1_svmRadial_e_100m_quesnel, main="Model1 NO-STEMS (SVM Radial epsilon-tuned)", cex.main=0.8, maxpixels=22000000) 
hist(wsvha_model2_svmRadial_e_100m_gaspard, main="Model2 WITH-STEMS (SVM Radial epsilon-tuned)", cex.main=0.8, maxpixels=22000000) 
hist(wsvha_model2_svmRadial_e_100m_quesnel, main="Model2 WITH-STEMS (SVM Radial epsilon-tuned)", cex.main=0.8, maxpixels=22000000) 
```

## Model: Support Vector Machine Linear Kernel

```{r, eval=FALSE}
tuneResult_svm_m1_full_linear <- train(
  X_m1, y_m1,
  trControl = fitControl_YeoJx10,
  method = 'svmLinear', metric = 'RMSE',
  ranges = list(cost = c(1,5,7,15,20), gamma = 2^(-1:1)),tuneLength = 10,
  preProc = c('YeoJohnson', 'scale', 'center', 'corr'),
  verbose=F)

tuneResult_svm_m2_full_linear <- train(
  X_m2, y_m2,
  trControl = fitControl_YeoJx10,
  method = 'svmLinear',metric = 'RMSE', 
  ranges = list(cost = c(1,5,7,15,20), gamma = 2^(-1:1)),tuneLength = 10,
  preProc = c('YeoJohnson', 'scale', 'center', 'corr'),
  verbose=F)

tunedModel_svm_m2_full_linear <- tuneResult_svm_m2_full_linear$finalModel
tunedModel_svm_m1_full_linear <- tuneResult_svm_m1_full_linear$finalModel
save(tunedModel_svm_m1_full_linear, file = "/media/seamus/128GB_WORKD/data/models/tcc-wsvha/wsvha_model1_svmLinear.RData")
save(tunedModel_svm_m2_full_linear, file = "/media/seamus/128GB_WORKD/data/models/tcc-wsvha/wsvha_model2_svmLinear.RData")

tuneResult_svmLinear_m2_10k_train <- train(
  X_train_m2, y_train_m2,
  trControl = fitControl_YeoJx10,
  method = 'svmLinear', metric = 'RMSE',
  ranges = list(cost = c(1,5,7,15,20), gamma = 2^(-1:1)),tuneLength = 10,
  preProc = c('YeoJohnson', 'scale', 'center', 'corr'),
  verbose=F)

tuneResult_svmLinear_m1_10k_train <- train(
  X_train_m1, y_train_m1,
  trControl = fitControl_YeoJx10,
  method = 'svmLinear',metric = 'RMSE',
  ranges = list(cost = c(1,5,7,15,20), gamma = 2^(-1:1)),tuneLength = 10,
  preProc = c('YeoJohnson', 'scale', 'center', 'corr'),
  verbose=F)

tunedModel_svmLinear_m2_test = predict(tuneResult_svmLinear_m2_10k_train, data = test_m2)
tunedModel_svmLinear_m1_test = predict(tuneResult_svmLinear_m1_10k_train, data = test_m1)
tunedModel_svmLinear_m2_test_MAE = MAE(tunedModel_svmLinear_m2_test, test_m2$wsvha_L)
tunedModel_svmLinear_m1_test_MAE = MAE(tunedModel_svmLinear_m1_test, test_m1$wsvha_L)
tunedModel_svmLinear_m2_test_RMSE = RMSE(tunedModel_svmLinear_m2_test, test_m2$wsvha_L)
tunedModel_svmLinear_m1_test_RMSE = RMSE(tunedModel_svmLinear_m1_test, test_m1$wsvha_L)

tunedModel_svmLinear_m2 = predict(tuneResult_svm_m2_full_linear, data = faib_vri_true_m2_df)
tunedModel_svmLinear_m1 = predict(tuneResult_svm_m1_full_linear, data = faib_vri_true_m1_df)
tunedModel_svmLinear_m2_MAE = MAE(tunedModel_svmLinear_m2, faib_vri_true_m2_df$wsvha_L)
tunedModel_svmLinear_m1_MAE = MAE(tunedModel_svmLinear_m1, faib_vri_true_m1_df$wsvha_L)
tunedModel_svmLinear_m2_RMSE = RMSE(tunedModel_svmLinear_m2, faib_vri_true_m2_df$wsvha_L)
tunedModel_svmLinear_m1_RMSE = RMSE(tunedModel_svmLinear_m1, faib_vri_true_m1_df$wsvha_L)

tunedModel_svm_m2_full_linear
R2(tunedModel_svmLinear_m2, y_m2)
tunedModel_svmLinear_m2_MAE
tunedModel_svmLinear_m2_RMSE 
tunedModel_svmLinear_m2_test_MAE
tunedModel_svmLinear_m2_test_RMSE
tunedModel_svmLinear_m2_RMSE/tunedModel_svmLinear_m2_test_RMSE

tunedModel_svm_m1_full_linear
R2(tunedModel_svmLinear_m1, y_m1)
tunedModel_svmLinear_m1_MAE
tunedModel_svmLinear_m1_RMSE 
tunedModel_svmLinear_m1_test_MAE
tunedModel_svmLinear_m1_test_RMSE
tunedModel_svmLinear_m1_RMSE/tunedModel_svmLinear_m1_test_RMSE

tunedModel_svm_m1_to_raster_linear <- raster::predict(covs_m1, tuneResult_svm_m1_full_linear)
tunedModel_svm_m2_to_raster_linear <- raster::predict(covs_m2, tuneResult_svm_m2_full_linear)
tunedModel_svm_m1_to_raster_linear_gaspard <- raster::predict(covs_m1_gaspard, tuneResult_svm_m1_full_linear)
tunedModel_svm_m2_to_raster_linear_gaspard <- raster::predict(covs_m2_gaspard, tuneResult_svm_m2_full_linear)
tunedModel_svm_m1_to_raster_linear_quesnel <- raster::predict(covs_m1_quesnel, tuneResult_svm_m1_full_linear)
tunedModel_svm_m2_to_raster_linear_quesnel <- raster::predict(covs_m2_quesnel, tuneResult_svm_m2_full_linear)
tunedModel_svm_m1_to_raster_linear$layer[tunedModel_svm_m1_to_raster_linear$layer <= 0] = 0
tunedModel_svm_m2_to_raster_linear$layer[tunedModel_svm_m2_to_raster_linear$layer <= 0] = 0
tunedModel_svm_m1_to_raster_linear_gaspard$layer[tunedModel_svm_m1_to_raster_linear_gaspard$layer <= 0] = 0
tunedModel_svm_m2_to_raster_linear_gaspard$layer[tunedModel_svm_m2_to_raster_linear_gaspard$layer <= 0] = 0
tunedModel_svm_m1_to_raster_linear_quesnel$layer[tunedModel_svm_m1_to_raster_linear_quesnel$layer <= 0] = 0
tunedModel_svm_m2_to_raster_linear_quesnel$layer[tunedModel_svm_m2_to_raster_linear_quesnel$layer <= 0] = 0
writeRaster(tunedModel_svm_m1_to_raster_linear, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmLinear_100m.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m2_to_raster_linear, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmLinear_100m.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m1_to_raster_linear_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmLinear_100m_gaspard.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m2_to_raster_linear_gaspard, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmLinear_100m_gaspard.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m1_to_raster_linear_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmLinear_100m_quesnel.tif", overwrite=TRUE)
writeRaster(tunedModel_svm_m2_to_raster_linear_quesnel, filename = "/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmLinear_100m_quesnel.tif", overwrite=TRUE)
```

```{r, fig.show='hold', out.width="25%", echo=FALSE}
wsvha_model1_svmLinear_100m_gaspard = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmLinear_100m_gaspard.tif")
wsvha_model2_svmLinear_100m_gaspard = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmLinear_100m_gaspard.tif")
wsvha_model1_svmLinear_100m_quesnel = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model1_svmLinear_100m_quesnel.tif")
wsvha_model2_svmLinear_100m_quesnel = raster::raster("/media/seamus/128GB_WORKD/data/raster/tcc/wsvha/bootstrapped/wsvha_model2_svmLinear_100m_quesnel.tif")
plot(wsvha_model1_svmLinear_100m_gaspard, main="Model1 NO-STEMS (SVM Linear)", cex.main=0.8, maxpixels=22000000)
plot(wsvha_model2_svmLinear_100m_gaspard, main="Model1 NO-STEMS (SVM Linear)", cex.main=0.8, maxpixels=22000000)
plot(wsvha_model1_svmLinear_100m_quesnel, main="Model2 WITH-STEMS (SVM Linear)", cex.main=0.8, maxpixels=22000000)
plot(wsvha_model2_svmLinear_100m_quesnel, main="Model2 WITH-STEMS (SVM Linear)", cex.main=0.8, maxpixels=22000000)
hist(wsvha_model1_svmLinear_100m_gaspard, main="Model1 NO-STEMS (SVM Linear)", cex.main=0.8, maxpixels=22000000) 
hist(wsvha_model2_svmLinear_100m_gaspard, main="Model1 NO-STEMS (SVM Linear)", cex.main=0.8, maxpixels=22000000) 
hist(wsvha_model1_svmLinear_100m_quesnel, main="Model2 WITH-STEMS (SVM Linear)", cex.main=0.8, maxpixels=22000000) 
hist(wsvha_model2_svmLinear_100m_quesnel, main="Model2 WITH-STEMS (SVM Linear)", cex.main=0.8, maxpixels=22000000) 
```
